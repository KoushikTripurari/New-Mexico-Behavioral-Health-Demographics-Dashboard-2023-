<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>US County Outline by FIPS — Customizable + Address Geocoder</title>

<style>
  :root{
    --ink:#2f3134;
    --fill:#63666A;
    --stroke:#4b4f55;
    --bg:#f7f8fa;

    --crisis:#ba0c2f;   /* Mobile Crisis Team (red circle) */
    --ccbhs:#0c8a96;    /* CCBHC (blue/teal square) */
    --ctc:#f39c12;      /* CTC (gold star) */
  }
  body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Helvetica Neue", sans-serif; color:var(--ink); background:var(--bg); }
  header, footer{ padding:12px 16px; }
  header h1{ margin:.25rem 0 .35rem; font-size:clamp(1.1rem, .9rem + 1.5vw, 1.6rem); }
  header p{ margin:0; opacity:.85 }
  .wrap{ max-width:1060px; margin:0 auto; padding:12px 16px 28px; }
  .card{ background:#fff; border:1px solid #e6e8eb; border-radius:12px; padding:12px; box-shadow:0 4px 14px rgba(0,0,0,.05); }

  .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin:10px 0 16px; }
  .controls label, .colors label, .pins-editor label, .checker label, .region-builder label{ font-size:.9rem; font-weight:700; display:block; margin-bottom:4px; }
  input[type="text"], input[type="number"], select, textarea{ width:100%; padding:.5rem .6rem; border:1px solid #dfe3e7; border-radius:8px; font-weight:600; background:#fff; }
  textarea{ min-height:70px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .row-btns{ display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
  button,a.button{ appearance:none; border:0; border-radius:10px; background:#007a86; color:#fff; padding:.55rem .9rem; font-weight:800; text-decoration:none; display:inline-flex; gap:.45rem; align-items:center; cursor:pointer; }
  button:hover, a.button:hover{ filter:brightness(1.05); transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.12) }
  .btn-secondary{ background:#4b4f55; }

  .mapbox{ position:relative; width:100%; aspect-ratio: 4 / 3; box-shadow:0 4px 20px rgba(0,0,0,.06) inset; border-radius:10px; overflow:hidden; background:#fff; }
  svg{ width:100%; height:100%; display:block; }
  .county{ fill:var(--fill); stroke:var(--stroke); stroke-width:1.6; vector-effect:non-scaling-stroke; }
  /* New styles for NM context & selected region */
  .county.context{ fill:#eceff2; stroke:#b8bec6; stroke-width:1; }
  .county.selected{ fill:var(--fill); stroke:#000000; stroke-width:2.2; }
  .region-label{ font-size:14px; font-weight:900; fill:#1f2326; paint-order:stroke; stroke:#ffffff; stroke-width:4px; stroke-linejoin:round; }

  .panel{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
  .coords{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

  /* Legend */
  .legend{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin:14px 0 8px; }
  .legend .item{ display:flex; gap:8px; align-items:center; }
  .legend .swatch{ width:16px; height:16px; border:2px solid #111; background:#ccc; display:inline-block; }
  .legend .swatch.crisis{ background:var(--crisis); border-radius:50% }
  .legend .swatch.ccbhc{ background:var(--ccbhs) }
  .legend .swatch.ctc{
    background:var(--ctc);
    clip-path:polygon(50% 0%, 62% 35%, 100% 35%, 69% 57%, 80% 92%, 50% 72%, 20% 92%, 31% 57%, 0% 35%, 38% 35%);
  }

  /* Pins (map symbols + labels) */
  .pins{ position:absolute; inset:0; pointer-events:none; }
  .pin{ position:absolute; transform:translate(-50%, -100%); filter: drop-shadow(0 2px 4px rgba(0,0,0,.28)); white-space:nowrap; font-size:12px; font-weight:700; color:#111; pointer-events:auto; }
  .pin .sym{ width:18px; height:18px; display:inline-block; border:2px solid #111; background:#ccc; }
  .pin .label{ position:absolute; left:10px; background:#fff; border:1px solid #e5e8ec; border-radius:6px; padding:2px 6px; box-shadow:0 2px 6px rgba(0,0,0,.07); }
  .pin.label-above .label{ top:-22px; }
  .pin.label-below .label{ top:6px; }
  .pin.crisis .sym{ background:var(--crisis); border-radius:50%; }
  .pin.ccbhc .sym{ background:var(--ccbhs); }
  .pin.ctc .sym{
    background:var(--ctc);
    clip-path:polygon(50% 0%, 62% 35%, 100% 35%, 69% 57%, 80% 92%, 50% 72%, 20% 92%, 31% 57%, 0% 35%, 38% 35%);
  }

  .pins-editor{ margin-top:18px; border-top:1px dashed #e2e6ea; padding-top:14px; }

  /* FINAL TABLE: solid black border, no delete buttons */
  table.pins-list{ width:100%; border-collapse: collapse; margin-top:8px; background:#fff; border:3px solid #000; border-radius:8px; overflow:hidden; }
  .pins-list th, .pins-list td{ padding:.6rem .75rem; border-top:1px solid #000; text-align:left; vertical-align:top; font-size:.95rem; }
  .pins-list th{ background:#fafbfc; font-weight:800; border-top:0; }
  .pins-list tr:first-child td{ border-top:0; }

  .checker{ margin-top:22px; border-top:2px solid #eef1f4; padding-top:14px; }
  .checker .grid{ grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .muted{ color:#6b7178; font-size:.9rem; }
  small.codehint{ display:block; color:#5a5f66; margin-top:4px; }
</style>
</head>
<body>
  <header class="wrap">
    <h1>US County Outline by FIPS — Customizable + Address Geocoder</h1>
    <p>Change the <strong>FIPS</strong>, label, and colors. Add a location by typing an <strong>address</strong>—we’ll fetch its <strong>latitude/longitude</strong> and place the pin.</p>
  </header>

  <main class="wrap card">
    <!-- County controls (single) -->
    <div class="controls grid">
      <div>
        <label for="fips">FIPS Code (5 digits)</label>
        <input id="fips" type="text" inputmode="numeric" placeholder="e.g., 35001" value="35001" maxlength="5" />
        <small class="codehint">Example: 35001 (Bernalillo), 35013 (Doña Ana)</small>
      </div>
      <div>
        <label for="labelText">Label Text</label>
        <input id="labelText" type="text" placeholder="e.g., Behavioral Region 2 (Bernalillo)" value="Behavioral Region 2 (Bernalillo)" />
      </div>
      <div>
        <label for="labelPos">Label Position</label>
        <select id="labelPos">
          <option value="left">Left Edge (vertical center)</option>
          <option value="centroid">At Centroid</option>
        </select>
      </div>
      <div class="row-btns">
        <button id="renderBtn" type="button">Render County</button>
        <button id="downloadBtn" type="button" title="Download the current SVG">Download SVG</button>
      </div>
    </div>

    <!-- NEW: Region Builder for New Mexico -->
    <div class="region-builder">
      <h3>Region Builder (New Mexico Counties)</h3>
      <div class="grid">
        <div>
          <label for="nmCountySelect">Add County by Name</label>
          <select id="nmCountySelect"></select>
          <small class="muted">Adds the correct 5-digit FIPS (NM = 35xxx).</small>
        </div>
        <div class="row-btns">
          <button id="addNmCountyBtn" type="button" class="btn-secondary">Add County</button>
          <button id="clearNmListBtn" type="button" class="btn-secondary">Clear List</button>
        </div>

        <div style="grid-column:1/-1;">
          <label for="nmFipsList">Selected FIPS (comma, space, or line-separated)</label>
          <textarea id="nmFipsList" placeholder="35001, 35006, 35013"></textarea>
          <small class="codehint">Tip: paste multiple FIPS; we’ll sanitize and de-duplicate.</small>
        </div>

        <div>
          <label for="nmRegionLabel">Region Label (optional)</label>
          <input id="nmRegionLabel" type="text" placeholder="e.g., Judicial District 2" />
        </div>
        <div>
          <label for="nmLabelPos">Region Label Position</label>
          <select id="nmLabelPos">
            <option value="centroid">At Centroid</option>
            <option value="left">Left Edge (vertical center)</option>
          </select>
        </div>
        <div>
          <label for="nmShowContext">Context</label>
          <select id="nmShowContext">
            <option value="on">Show Entire NM (light grey)</option>
            <option value="off">Only Selected Counties</option>
          </select>
        </div>
        <div class="row-btns">
          <button id="renderNmRegionBtn" type="button">Render NM Region</button>
        </div>
      </div>
    </div>

    <!-- Color controls -->
    <div class="colors grid">
      <div>
        <label for="hexFill">Map Fill Color (hex)</label>
        <input id="hexFill" type="text" placeholder="#RRGGBB" value="#63666A" />
      </div>
      <div>
        <label for="hexStroke">Map Stroke Color (hex)</label>
        <input id="hexStroke" type="text" placeholder="#RRGGBB" value="#4b4f55" />
      </div>
      <div>
        <label for="hexCrisis">Mobile Crisis Team (hex)</label>
        <input id="hexCrisis" type="text" placeholder="#RRGGBB" value="#ba0c2f" />
      </div>
      <div>
        <label for="hexCCBHC">CCBHC (hex)</label>
        <input id="hexCCBHC" type="text" placeholder="#RRGGBB" value="#0c8a96" />
      </div>
      <div>
        <label for="hexCTC">Crisis Triage Center (hex)</label>
        <input id="hexCTC" type="text" placeholder="#RRGGBB" value="#f39c12" />
      </div>
      <div class="row-btns">
        <button id="applyColorsBtn" type="button">Apply Colors</button>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="mapbox" aria-label="County outline map">
      <div id="pinLayer" class="pins" aria-hidden="false"></div>
    </div>

    <div class="panel">
      <div class="coords" id="coords">Centroid: …</div>
      <div class="coords" id="meta">FIPS: 35001</div>
    </div>

    <!-- Pins editor -->
    <div class="pins-editor">
      <h3>Add Locations</h3>
      <div class="grid">
        <div style="grid-column:1/-1;">
          <label for="pinAddress">Address (we’ll geocode this)</label>
          <input id="pinAddress" type="text" placeholder="1210 San Mateo SE, Albuquerque, NM 87108" />
          <small class="muted">Tip: Include city, state, ZIP for best accuracy.</small>
        </div>
        <div>
          <label for="pinType">Type</label>
          <select id="pinType">
            <option value="crisis">Mobile Crisis Team (red circle)</option>
            <option value="ccbhc">CCBHC (blue square)</option>
            <option value="ctc">Crisis Triage Center (gold star)</option>
          </select>
        </div>
        <div>
          <label for="pinName">Name</label>
          <input id="pinName" type="text" placeholder="e.g., Crisis Triage Center" />
        </div>
        <div>
          <label for="pinCounty">County</label>
          <input id="pinCounty" type="text" placeholder="e.g., Bernalillo" />
        </div>
        <div>
          <label for="pinZip">Zip Code</label>
          <input id="pinZip" type="text" placeholder="e.g., 87106" />
        </div>
        <div>
          <label for="pinLat">Latitude (auto-filled)</label>
          <input id="pinLat" type="number" step="0.000001" placeholder="e.g., 35.084385" />
        </div>
        <div>
          <label for="pinLon">Longitude (auto-filled)</label>
          <input id="pinLon" type="number" step="0.000001" placeholder="-106.650422" />
        </div>
        <div>
          <label for="pinLabelPos">Label Position</label>
          <select id="pinLabelPos">
            <option value="auto">Auto (CTC below, others above)</option>
            <option value="above">Above</option>
            <option value="below">Below</option>
          </select>
        </div>
        <div class="row-btns">
          <button id="geocodeBtn" type="button" class="btn-secondary">Geocode Address</button>
          <button id="addPinBtn" type="button">Add Pin</button>
          <button id="clearPinsBtn" type="button" class="btn-secondary">Clear All Pins</button>
        </div>
      </div>

      <!-- Legend moved ABOVE the final table -->
      <div class="legend" aria-label="Legend">
        <div class="item"><span class="swatch crisis"></span> Mobile Crisis Team</div>
        <div class="item"><span class="swatch ccbhc"></span> CCBHC</div>
        <div class="item"><span class="swatch ctc"></span> Crisis Triage Center</div>
      </div>

      <!-- FINAL table (black border, no delete icons) -->
      <table class="pins-list" id="pinsTable" aria-label="Locations table">
        <thead>
          <tr>
            <th>Name</th><th>County</th><th>Address</th><th>Zip Code</th><th>Type</th>
          </tr>
        </thead>
        <tbody id="pinsTbody"></tbody>
      </table>
    </div>

    <!-- Latitude & Longitude Checker -->
    <div class="checker">
      <h3>Latitude & Longitude Checker</h3>
      <div class="grid">
        <div>
          <label for="chkAddress">Address → Coordinates</label>
          <input id="chkAddress" type="text" placeholder="Enter any address…" />
        </div>
        <div class="row-btns">
          <button id="chkGeocodeBtn" type="button">Get Lat/Lon</button>
        </div>
        <div>
          <label for="chkLat">Reverse: Latitude</label>
          <input id="chkLat" type="number" step="0.000001" placeholder="e.g., 35.0844" />
        </div>
        <div>
          <label for="chkLon">Reverse: Longitude</label>
          <input id="chkLon" type="number" step="0.000001" placeholder="-106.6504" />
        </div>
        <div class="row-btns">
          <button id="chkReverseBtn" type="button" class="btn-secondary">Get Address</button>
        </div>
      </div>
      <p id="chkResult" class="muted">Results will appear here.</p>
      <small class="muted">Geocoding by OpenStreetMap Nominatim. Please set your contact email in the script for responsible use.</small>
    </div>
  </main>

  <footer class="wrap">
    Data: <a href="https://github.com/topojson/us-atlas" target="_blank" rel="noopener">us-atlas counties-10m</a>. Rendering: D3 + TopoJSON client. Geocoding: OpenStreetMap Nominatim (client-side).
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <script>
  const NOMINATIM_EMAIL = "YOUR_EMAIL@EXAMPLE.COM";
  let topoCache = null, svg = null, path = null, projection = null;
  let currentFips = "35001";
  const pins = [];

  // ------- NM county name -> FIPS map (33 counties) -------
  const NM_COUNTIES = [
    ["Bernalillo", "35001"], ["Catron", "35003"], ["Chaves", "35005"], ["Cibola", "35006"],
    ["Colfax", "35007"], ["Curry", "35009"], ["De Baca", "35011"], ["Doña Ana", "35013"],
    ["Eddy", "35015"], ["Grant", "35017"], ["Guadalupe", "35019"], ["Harding", "35021"],
    ["Hidalgo", "35023"], ["Lea", "35025"], ["Lincoln", "35027"], ["Los Alamos", "35028"],
    ["Luna", "35029"], ["McKinley", "35031"], ["Mora", "35033"], ["Otero", "35035"],
    ["Quay", "35037"], ["Rio Arriba", "35039"], ["Roosevelt", "35041"], ["Sandoval", "35043"],
    ["San Juan", "35045"], ["San Miguel", "35047"], ["Santa Fe", "35049"], ["Sierra", "35051"],
    ["Socorro", "35053"], ["Taos", "35055"], ["Torrance", "35057"], ["Union", "35059"],
    ["Valencia", "35061"],
  ];
  const nmSelect = () => document.getElementById("nmCountySelect");

  // Populate dropdown
  document.addEventListener("DOMContentLoaded", () => {
    const sel = nmSelect();
    sel.innerHTML = NM_COUNTIES.map(([n,f]) => `<option value="${f}">${n} — ${f}</option>`).join("");
  });

  async function loadTopo(){
    if (topoCache) return topoCache;
    topoCache = await fetch("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json").then(r => r.json());
    return topoCache;
  }

  function clearMap(){ document.getElementById("map").querySelector("svg")?.remove(); }

  function applyHexVar(cssVar, value){
    const hex = (value || "").trim();
    if (/^#[0-9a-fA-F]{6}$/.test(hex)) { document.documentElement.style.setProperty(cssVar, hex); return true; }
    return false;
  }
  function applyAllColorsFromInputs(){
    const ok = [
      applyHexVar("--fill",   document.getElementById("hexFill").value),
      applyHexVar("--stroke", document.getElementById("hexStroke").value),
      applyHexVar("--crisis", document.getElementById("hexCrisis").value),
      applyHexVar("--ccbhs",  document.getElementById("hexCCBHC").value),
      applyHexVar("--ctc",    document.getElementById("hexCTC").value),
    ].every(Boolean);
    if (!ok) alert("Please use valid 6-digit hex colors like #1E5D30.");
  }

  // ---------- SINGLE county ----------
  async function renderCountyByFIPS(fips, labelText, labelPos){
    const topo = await loadTopo();
    const counties = topojson.feature(topo, topo.objects.counties);
    const county = counties.features.find(f => f.id === fips);
    clearMap();

    const box = document.getElementById("map");
    const W = box.clientWidth, H = box.clientHeight;

    svg = d3.select("#map").append("svg")
      .attr("viewBox", `0 0 ${W} ${H}`)
      .attr("role","img")
      .attr("aria-label","US county outline");

    if(!county){
      svg.append("text").attr("x", W/2).attr("y", H/2).attr("text-anchor","middle").attr("fill", "#ba0c2f").attr("font-weight", 800).text(`FIPS ${fips} not found`);
      document.getElementById("coords").textContent = "Centroid: —";
      document.getElementById("meta").textContent = `FIPS: ${fips}`;
      return;
    }

    projection = d3.geoAlbersUsa(); projection.fitSize([W, H], county);
    path = d3.geoPath(projection);

    svg.append("path").attr("class","county").attr("d", path(county));

    if (labelPos === "centroid") {
      const [cx, cy] = path.centroid(county);
      svg.append("text").attr("class","region-label").attr("x", cx).attr("y", cy).attr("text-anchor","middle").attr("dy",".35em").text(labelText || `FIPS ${fips}`);
    } else {
      const cy = path.centroid(county)[1];
      svg.append("text").attr("class","region-label").attr("x", 16).attr("y", cy).attr("text-anchor","start").attr("dy",".35em").text(labelText || `FIPS ${fips}`);
    }

    const [lon, lat] = d3.geoCentroid(county);
    document.getElementById("coords").textContent = `Centroid: ${lat.toFixed(6)}, ${lon.toFixed(6)}  (WGS84)`;
    document.getElementById("meta").textContent = `FIPS: ${fips}`;
    renderPins();
  }

  // ---------- MULTI-county (NM Region) ----------
  function parseFipsList(raw){
    const list = (raw || "").split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
    // Keep only 5-digit numbers, de-duplicate
    return Array.from(new Set(list.filter(s => /^\d{5}$/.test(s))));
  }

  async function renderNMRegion(fipsList, regionLabel, labelPos, showContext){
    const topo = await loadTopo();
    const counties = topojson.feature(topo, topo.objects.counties);
    // All NM counties (state FIPS '35')
    const nmAll = counties.features.filter(f => String(f.id).startsWith("35"));
    const selected = nmAll.filter(f => fipsList.includes(f.id));

    clearMap();
    const box = document.getElementById("map");
    const W = box.clientWidth, H = box.clientHeight;

    svg = d3.select("#map").append("svg")
      .attr("viewBox", `0 0 ${W} ${H}`)
      .attr("role","img")
      .attr("aria-label","New Mexico counties");

    if (selected.length === 0){
      const msg = "No NM counties selected.";
      svg.append("text").attr("x", W/2).attr("y", H/2).attr("text-anchor","middle").attr("fill", "#ba0c2f").attr("font-weight", 800).text(msg);
      document.getElementById("coords").textContent = "Centroid: —";
      document.getElementById("meta").textContent = "NM Region: —";
      return;
    }

    // Fit to selected collection (or entire NM if context is on, so pins remain usable statewide)
    const fitCollection = (showContext === "on")
      ? { type:"FeatureCollection", features: nmAll }
      : { type:"FeatureCollection", features: selected };

    projection = d3.geoAlbersUsa(); projection.fitSize([W, H], fitCollection);
    path = d3.geoPath(projection);

    // Draw NM context first (light grey)
    if (showContext === "on"){
      svg.append("g").selectAll("path")
        .data(nmAll)
        .enter().append("path")
        .attr("class","county context")
        .attr("d", d => path(d));
    }

    // Draw selected counties on top (your fill + black outlines)
    svg.append("g").selectAll("path")
      .data(selected)
      .enter().append("path")
      .attr("class","county selected")
      .attr("d", d => path(d));

    // Region label
    const label = regionLabel && regionLabel.trim() ? regionLabel.trim() : `NM Region (${fipsList.length} counties)`;
    if (labelPos === "centroid"){
      const [cx, cy] = path.centroid({ type:"FeatureCollection", features: selected });
      svg.append("text").attr("class","region-label").attr("x", cx).attr("y", cy).attr("text-anchor","middle").attr("dy",".35em").text(label);
    } else {
      const cy = path.centroid({ type:"FeatureCollection", features: selected })[1];
      svg.append("text").attr("class","region-label").attr("x", 16).attr("y", cy).attr("text-anchor","start").attr("dy",".35em").text(label);
    }

    // Meta + coords (use geographic centroid of selection)
    const [lon, lat] = d3.geoCentroid({ type:"FeatureCollection", features: selected });
    document.getElementById("coords").textContent = `Selection centroid: ${lat.toFixed(6)}, ${lon.toFixed(6)}  (WGS84)`;
    document.getElementById("meta").textContent = `NM Region FIPS: ${fipsList.join(", ")}`;

    renderPins();
  }

  function resolveLabelPosClass(pin){
    if (pin.labelPos === "above") return "label-above";
    if (pin.labelPos === "below") return "label-below";
    return pin.type === "ctc" ? "label-below" : "label-above";
  }

  function renderPins(){
    const layer = document.getElementById("pinLayer");
    layer.innerHTML = "";
    if (!projection) return;

    pins.forEach((p) => {
      const xy = projection([p.lon, p.lat]); if (!xy) return;
      const [x, y] = xy;
      const div = document.createElement("div");
      div.className = `pin ${p.type} ${resolveLabelPosClass(p)}`;
      div.style.left = x + "px"; div.style.top  = y + "px";
      div.title = p.address ? `${p.name}\n${p.address}` : p.name;

      const sym = document.createElement("span"); sym.className = "sym";
      const label = document.createElement("span"); label.className = "label"; label.textContent = p.name;

      div.appendChild(sym); div.appendChild(label); layer.appendChild(div);
    });
  }

  function typeLabel(t){ return t==="crisis"?"Mobile Crisis Team":t==="ccbhc"?"CCBHC":t==="ctc"?"Crisis Triage Center":t; }

  function refreshPinsTable(){
    const tbody = document.getElementById("pinsTbody");
    tbody.innerHTML = "";
    pins.forEach((p) => {
      const tr = document.createElement("tr");
      tr.appendChild(cell(p.name));
      tr.appendChild(cell(p.county || ""));
      tr.appendChild(cell(p.address || ""));
      tr.appendChild(cell(p.zip || ""));
      tr.appendChild(cell(typeLabel(p.type)));
      tbody.appendChild(tr);
    });
    function cell(txt){ const td = document.createElement("td"); td.textContent = txt || ""; return td; }
  }

  function addPinFromForm(){
    const name = document.getElementById("pinName").value.trim();
    const type = document.getElementById("pinType").value;
    const county = document.getElementById("pinCounty").value.trim();
    const zip = document.getElementById("pinZip").value.trim();
    const lat  = parseFloat(document.getElementById("pinLat").value);
    const lon  = parseFloat(document.getElementById("pinLon").value);
    const addr = document.getElementById("pinAddress").value.trim();
    const labelPos = document.getElementById("pinLabelPos").value;

    if (!name || !type || isNaN(lat) || isNaN(lon)){
      alert("Please provide Name, Type, and valid Latitude/Longitude (use Geocode Address if needed).");
      return;
    }
    pins.push({ name, type, county, address: addr, zip, lat, lon, labelPos });
    renderPins(); refreshPinsTable();
  }

  function downloadSVG(filename){
    if (!svg) return;
    const serializer = new XMLSerializer();
    const raw = serializer.serializeToString(svg.node());
    const file = new Blob([raw], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(file);
    const a = document.createElement("a");
    a.href = url; a.download = filename || "county_outline.svg";
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function buildNominatimParams(obj){
    const params = new URLSearchParams(obj);
    if (NOMINATIM_EMAIL && NOMINATIM_EMAIL.includes("@")) { params.set("email", NOMINATIM_EMAIL); }
    return params.toString();
  }
  async function geocodeAddress(address){
    const q = (address || "").trim(); if (!q) throw new Error("Empty address.");
    const url = "https://nominatim.openstreetmap.org/search?" + buildNominatimParams({ q, format:"jsonv2", addressdetails:1, limit:1 });
    const r = await fetch(url, { headers: { "Accept": "application/json" }}); if (!r.ok) throw new Error("Geocoding failed.");
    const data = await r.json(); if (!data || !data.length) throw new Error("No match found.");
    const { lat, lon, display_name } = data[0]; return { lat: parseFloat(lat), lon: parseFloat(lon), display_name };
  }
  async function reverseGeocode(lat, lon){
    const url = "https://nominatim.openstreetmap.org/reverse?" + buildNominatimParams({ lat, lon, format:"jsonv2", addressdetails:1 });
    const r = await fetch(url, { headers: { "Accept": "application/json" }}); if (!r.ok) throw new Error("Reverse geocoding failed.");
    const data = await r.json(); if (!data) throw new Error("No result.");
    return { display_name: data.display_name || "(no address)", address: data.address || {} };
  }

  // UI wiring — single county
  document.getElementById("renderBtn").addEventListener("click", () => {
    const fips = document.getElementById("fips").value.trim();
    const labelText = document.getElementById("labelText").value.trim();
    const labelPos = document.getElementById("labelPos").value;
    if (!/^\d{5}$/.test(fips)) { alert("Please enter a 5-digit FIPS code (e.g., 35001)."); return; }
    currentFips = fips;
    const params = new URLSearchParams(location.search);
    params.set("fips", fips); params.set("label", labelText); params.set("pos", labelPos);
    history.replaceState({}, "", `${location.pathname}?${params.toString()}`);
    renderCountyByFIPS(fips, labelText, labelPos);
  });
  document.getElementById("downloadBtn").addEventListener("click", () => downloadSVG(`county_${currentFips}.svg`));
  document.getElementById("applyColorsBtn").addEventListener("click", () => { applyAllColorsFromInputs(); renderPins(); });

  // UI wiring — NM Region Builder
  document.getElementById("addNmCountyBtn").addEventListener("click", () => {
    const fips = nmSelect().value;
    const box = document.getElementById("nmFipsList");
    const list = parseFipsList(box.value);
    if (!list.includes(fips)) list.push(fips);
    box.value = list.join(", ");
  });
  document.getElementById("clearNmListBtn").addEventListener("click", () => {
    document.getElementById("nmFipsList").value = "";
  });
  document.getElementById("renderNmRegionBtn").addEventListener("click", () => {
    const fipsList = parseFipsList(document.getElementById("nmFipsList").value).filter(f => f.startsWith("35"));
    if (fipsList.length === 0){
      alert("Add at least one New Mexico county (FIPS starts with 35).");
      return;
    }
    const label = document.getElementById("nmRegionLabel").value;
    const pos = document.getElementById("nmLabelPos").value;
    const ctx = document.getElementById("nmShowContext").value;
    renderNMRegion(fipsList, label, pos, ctx);
  });

  // Pins editor
  document.getElementById("geocodeBtn").addEventListener("click", async () => {
    const addr = document.getElementById("pinAddress").value.trim();
    if (!addr) { alert("Please enter an address to geocode."); return; }
    try{
      const res = await geocodeAddress(addr);
      document.getElementById("pinLat").value = res.lat.toFixed(6);
      document.getElementById("pinLon").value = res.lon.toFixed(6);
      if (!document.getElementById("pinName").value.trim()){
        document.getElementById("pinName").value = res.display_name.split(",")[0];
      }
    }catch(err){ alert("Geocoding error: " + err.message); }
  });
  document.getElementById("addPinBtn").addEventListener("click", addPinFromForm);
  document.getElementById("clearPinsBtn").addEventListener("click", () => {
    if (confirm("Remove all pins?")) { pins.length = 0; renderPins(); refreshPinsTable(); }
  });

  // Checker
  document.getElementById("chkGeocodeBtn").addEventListener("click", async () => {
    const addr = document.getElementById("chkAddress").value.trim();
    const out = document.getElementById("chkResult");
    if (!addr){ out.textContent = "Enter an address first."; return; }
    try{ const res = await geocodeAddress(addr); out.textContent = `Lat: ${res.lat.toFixed(6)}, Lon: ${res.lon.toFixed(6)} — ${res.display_name}`; }
    catch(err){ out.textContent = "Geocoding error: " + err.message; }
  });
  document.getElementById("chkReverseBtn").addEventListener("click", async () => {
    const lat = parseFloat(document.getElementById("chkLat").value);
    const lon = parseFloat(document.getElementById("chkLon").value);
    const out = document.getElementById("chkResult");
    if (isNaN(lat) || isNaN(lon)){ out.textContent = "Enter both latitude and longitude."; return; }
    try{ const res = await reverseGeocode(lat, lon); out.textContent = res.display_name; }
    catch(err){ out.textContent = "Reverse geocoding error: " + err.message; }
  });

  // Init
  (function initFromQuery(){
    const params = new URLSearchParams(location.search);
    const fips = params.get("fips") || "35001";
    const label = params.get("label") || "Behavioral Region 2 (Bernalillo)";
    const pos = params.get("pos") || "left";
    currentFips = fips;
    document.getElementById("fips").value = fips;
    document.getElementById("labelText").value = label;
    document.getElementById("labelPos").value = pos;
    applyAllColorsFromInputs();
    renderCountyByFIPS(fips, label, pos);
  })();
  </script>
  <!-- ====== Quick Links Section ====== -->
<section class="quick-links">
  <h2 class="ql-title">Explore More</h2>
  <div class="ql-grid">
    <!-- 1) Demographics -->
    <a class="ql-card" href="https://koushiktripurari19986.wordpress.com" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">👥</span>
      <span class="ql-text">
        <span class="ql-heading">Demographics</span>
        <span class="ql-sub">Population, age, geography</span>
      </span>
    </a>

    <!-- 2) Diagnoses counts -->
    <a class="ql-card" href="https://public.tableau.com/app/profile/koushik.tripurari" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🧾</span>
      <span class="ql-text">
        <span class="ql-heading">Diagnoses Counts</span>
        <span class="ql-sub">State & region breakdowns</span>
      </span>
    </a>

    <!-- 3) Service counts -->
    <a class="ql-card" href="https://github.com/koushiktripurari" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🩺</span>
      <span class="ql-text">
        <span class="ql-heading">Service Counts</span>
        <span class="ql-sub">BHOP, IOP, Crisis, Residential</span>
      </span>
    </a>

    <!-- 4) Crisis data -->
    <a class="ql-card" href="https://prezi.com/view/CHW-CHR-Guide-Registration-Steps" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">📟</span>
      <span class="ql-text">
        <span class="ql-heading">Crisis Data</span>
        <span class="ql-sub">ED visits, mobile crisis, CTC</span>
      </span>
    </a>

    <!-- 5) County maps: CCBHC, CTC & Crisis -->
    <a class="ql-card" href="https://www.linkedin.com/in/koushiktripurari" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🗺️</span>
      <span class="ql-text">
        <span class="ql-heading">County Maps — CCBHC, CTC & Crisis</span>
        <span class="ql-sub">Coverage & access by county</span>
      </span>
    </a>
  </div>
</section>

<!-- ====== Minimal Styles ====== -->
<style>
  :root{
    --ql-ink:#111827; --ql-sub:#6b7280; --ql-bg:#ffffff; --ql-line:#e5e7eb;
    --ql-card:#f9fafb; --ql-card-hover:#eef2ff; --ql-border:#e5e7eb;
    --ql-shadow:0 1px 2px rgba(0,0,0,.06), 0 4px 10px rgba(0,0,0,.04);
  }
  .quick-links{margin:24px 0; padding:8px 0}
  .ql-title{margin:0 0 12px; font:600 18px/1.3 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ql-ink)}
  .ql-grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }
  .ql-card{
    display:flex; gap:12px; align-items:center;
    padding:14px 16px; border-radius:14px;
    background:var(--ql-card); border:1px solid var(--ql-border);
    text-decoration:none; color:var(--ql-ink);
    box-shadow:var(--ql-shadow); transition:transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .ql-card:hover{ transform:translateY(-2px); background:var(--ql-card-hover); border-color:#c7d2fe }
  .ql-emoji{font-size:22px}
  .ql-text{display:flex; flex-direction:column}
  .ql-heading{font-weight:700}
  .ql-sub{font-size:12px; color:var(--ql-sub)}
</style>

</body>
</html>

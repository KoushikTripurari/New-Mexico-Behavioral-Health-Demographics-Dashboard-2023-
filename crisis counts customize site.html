<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crisis Call Rates Comparison — Customizable (with Separate Color Apply)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
  body{background:linear-gradient(135deg,#f5f7fa 0%,#e4e8f0 100%);color:#333;padding:20px;min-height:100vh;display:flex;justify-content:center;align-items:flex-start}
  .container{max-width:1200px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden;width:100%}

  header{background:#2c3e50;color:#fff;padding:25px;text-align:center}
  h1{font-size:28px;margin-bottom:10px}
  .subtitle{font-size:18px;opacity:.9}

  /* Customizer */
  .customizer{padding:20px;background:#f8fafc;border-bottom:1px solid #e7ecf1}
  .grid{display:grid;gap:14px}
  .grid.cols-4{grid-template-columns:repeat(4, minmax(180px,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3, minmax(180px,1fr))}
  .grid.cols-2{grid-template-columns:repeat(2, minmax(180px,1fr))}
  .group{background:#ffffff;border:1px solid #e6e9ee;border-radius:10px;padding:14px}
  .group h3{font-size:16px;margin-bottom:10px;color:#2c3e50}
  label{display:block;font-size:12px;font-weight:700;color:#334155;margin-bottom:6px}
  input[type="text"],input[type="number"],input[type="color"]{
    width:100%;padding:.55rem .65rem;border:1px solid #d8dee6;border-radius:8px;font-weight:600;background:#fff
  }
  .hint{font-size:12px;color:#6b7280;margin-top:4px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:10px;background:#3498db;color:#fff;padding:.6rem 1rem;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(1.05);transform:translateY(-1px);box-shadow:0 8px 16px rgba(0,0,0,.12)}
  .btn.secondary{background:#7f8c8d}
  .input-invalid{border-color:#dc2626 !important; box-shadow:0 0 0 3px rgba(220,38,38,.1)}

  /* Main content */
  .content{padding:30px;display:grid;grid-template-columns:1fr 1fr;gap:30px}
  .card{padding:25px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  /* Neutral fallbacks; JS sets themed gradients dynamically */
  .br-card{background:#f1f2f6}
  .nm-card{background:#ebf5fb}
  h2{font-size:22px;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px}

  .metrics{display:grid;grid-template-columns:1fr 1fr;gap:15px}
  .metric{padding:15px;background:rgba(255,255,255,.7);border-radius:8px;text-align:center}
  .metric-title{font-weight:600;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
  .value{font-size:20px;font-weight:700;margin:5px 0}
  .year{font-size:14px;color:#7f8c8d;margin-top:5px}

  .rate-container{text-align:center;margin:25px 0 15px}
  .rate{font-size:32px;font-weight:800;padding:15px;border-radius:10px;display:inline-block;min-width:180px}
  .trend{display:flex;align-items:center;justify-content:center;gap:8px;font-weight:600;margin-top:10px}

  .data-table{grid-column:span 2;width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  .data-table th{background:#2c3e50;color:#fff;padding:15px;text-align:center}
  .data-table td{padding:12px 15px;text-align:center;border-bottom:1px solid #eaeaea}
  .data-table tr:nth-child(even){background:#f8f9fa}
  .data-table tr:last-child td{border-bottom:none}

  .data-highlight{background:#2c3e50;color:#fff;padding:15px;border-radius:10px;text-align:center;margin-top:20px;grid-column:span 2}

  .comparison{grid-column:span 2;background:#fff;padding:25px;border-radius:12px;margin-top:20px}
  .chart-container{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-top:20px}
  .chart{background:#f8f9fa;padding:20px;border-radius:10px}
  .chart-title{text-align:center;margin-bottom:15px;font-weight:600;color:#2c3e50}
  .bar-container{height:30px;background:#ecf0f1;border-radius:15px;margin:15px 0;overflow:hidden;position:relative}
  .bar{height:100%;border-radius:15px;display:flex;align-items:center;justify-content:flex-end;padding-right:15px;color:#fff;font-weight:bold;font-size:14px}

  .legend{display:flex;justify-content:center;gap:30px;margin-top:20px}
  .legend-item{display:flex;align-items:center;gap:10px}
  .color-box{width:20px;height:20px;border-radius:4px;border:1px solid #cbd5e1}

  .key-takeaway{grid-column:span 2;background:#fff9e6;padding:25px;border-radius:12px;margin-top:20px;border-left:5px solid #f1c40f}
  .key-takeaway h3{display:flex;align-items:center;gap:10px;margin-bottom:15px;color:#d35400}
  .key-takeaway ul{list-style-type:none}
  .key-takeaway li{margin:12px 0;padding-left:30px;position:relative}
  .key-takeaway li:before{content:"•";color:#f39c12;font-size:24px;position:absolute;left:0;top:-5px}

  footer{text-align:center;padding:20px;color:#7f8c8d;font-size:14px;grid-column:span 2}

  @media (max-width:768px){
    .content{grid-template-columns:1fr}
    .data-table,.data-highlight,.comparison,.key-takeaway,footer{grid-column:1}
    .chart-container{grid-template-columns:1fr}
    .grid.cols-4{grid-template-columns:repeat(2, minmax(160px,1fr))}
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="pageTitle">Crisis Call Rates: <span id="brNameTitle">BR3</span> vs. New Mexico</h1>
      <div class="subtitle">Comparison of crisis call data (2023–2024)</div>
    </header>

    <!-- Customizer Panel -->
    <section class="customizer">
      <div class="grid cols-4">
        <div class="group">
          <h3>Region</h3>
          <label for="brName">BR Name</label>
          <input id="brName" type="text" value="BR3" />
          <p class="hint">Appears in headings/labels.</p>
        </div>

        <div class="group">
          <h3><span id="brNameLbl">BR3</span> — 2023</h3>
          <label for="brPop23">Population</label>
          <input id="brPop23" type="number" value="225210" />
          <label for="brCalls23" style="margin-top:8px">Crisis Calls</label>
          <input id="brCalls23" type="number" value="1831" />
        </div>

        <div class="group">
          <h3><span id="brNameLbl2">BR3</span> — 2024</h3>
          <label for="brPop24">Population</label>
          <input id="brPop24" type="number" value="229366" />
          <label for="brCalls24" style="margin-top:8px">Crisis Calls</label>
          <input id="brCalls24" type="number" value="1733" />
        </div>

        <div class="group">
          <h3>Quick Actions</h3>
          <div class="row">
            <button id="applyBtn" class="btn">Apply Changes</button>
          </div>
          <p class="hint">Updates cards, table, rates & bars (numbers/text only).</p>
        </div>
      </div>

      <div class="grid cols-4" style="margin-top:14px">
        <div class="group">
          <h3>New Mexico — 2023</h3>
          <label for="nmPop23">Population</label>
          <input id="nmPop23" type="number" value="2117522" />
          <label for="nmCalls23" style="margin-top:8px">Crisis Calls</label>
          <input id="nmCalls23" type="number" value="29977" />
        </div>

        <div class="group">
          <h3>New Mexico — 2024</h3>
          <label for="nmPop24">Population</label>
          <input id="nmPop24" type="number" value="2130256" />
          <label for="nmCalls24" style="margin-top:8px">Crisis Calls</label>
          <input id="nmCalls24" type="number" value="28137" />
        </div>

        <div class="group">
          <h3>Bar Scaling (optional)</h3>
          <label for="minBarPct">Min Bar Width % (readability)</label>
          <input id="minBarPct" type="number" value="10" />
          <p class="hint">Keeps tiny bars visible (0–30 recommended).</p>
        </div>

        <!-- COLORS: Hex + picker, live preview + separate Apply -->
        <div class="group">
          <h3>Colors</h3>

          <!-- Region color -->
          <label for="brColor">Region color (picker)</label>
          <div class="row">
            <input id="brColor" type="color" value="#7f8c8d" style="width:120px" />
            <input id="brColorHex" type="text" value="#7f8c8d" placeholder="#RRGGBB" aria-label="Region hex color" style="width:140px" />
            <span id="brSwatch" title="Region color preview" style="display:inline-block;width:20px;height:20px;border-radius:4px;border:1px solid #cbd5e1;background:#7f8c8d"></span>
          </div>
          <p class="hint">Enter a hex like <code>#1E5D30</code> or use the picker.</p>

          <!-- State color -->
          <label for="nmColor" style="margin-top:10px">State color (picker)</label>
          <div class="row">
            <input id="nmColor" type="color" value="#3498db" style="width:120px" />
            <input id="nmColorHex" type="text" value="#3498db" placeholder="#RRGGBB" aria-label="State hex color" style="width:140px" />
            <span id="nmSwatch" title="State color preview" style="display:inline-block;width:20px;height:20px;border-radius:4px;border:1px solid #cbd5e1;background:#3498db"></span>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="applyColorsBtn" class="btn secondary">Apply Colors Only</button>
          </div>
          <p class="hint">Applies to cards, table tints, bars & legend. (Does not change numbers/text.)</p>
        </div>
      </div>
    </section>

    <div class="content">
      <!-- BR Card -->
      <div class="card br-card" id="brCard" style="border-left:5px solid #7f8c8d">
        <h2><i class="fas fa-building"></i> <span id="brNameCard">BR3</span> Service Area</h2>
        <div class="metrics">
          <div class="metric">
            <div class="metric-title"><i class="fas fa-users"></i> Total Population</div>
            <div class="value" id="brPop23Txt">225,210</div>
            <div class="year">2023</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-users"></i> Total Population</div>
            <div class="value" id="brPop24Txt">229,366</div>
            <div class="year">2024</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-phone"></i> Crisis Calls</div>
            <div class="value" id="brCalls23Txt">1,831</div>
            <div class="year">2023</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-phone"></i> Crisis Calls</div>
            <div class="value" id="brCalls24Txt">1,733</div>
            <div class="year">2024</div>
          </div>
        </div>

        <div class="rate-container">
          <div class="rate" id="brRate23" style="background:#7f8c8d;color:#fff">0.81% (2023)</div>
          <div class="rate" id="brRate24" style="background:#7f8c8d;color:#fff">0.76% (2024)</div>
          <div class="trend" id="brTrend"><i class="fas fa-arrow-down"></i> <span>Decreased from 2023 to 2024</span></div>
        </div>
      </div>

      <!-- NM Card -->
      <div class="card nm-card" id="nmCard" style="border-left:5px solid #3498db">
        <h2><i class="fas fa-map-marked-alt"></i> State of New Mexico</h2>
        <div class="metrics">
          <div class="metric">
            <div class="metric-title"><i class="fas fa-users"></i> Total Population</div>
            <div class="value" id="nmPop23Txt">2,117,522</div>
            <div class="year">2023</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-users"></i> Total Population</div>
            <div class="value" id="nmPop24Txt">2,130,256</div>
            <div class="year">2024</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-phone"></i> Crisis Calls</div>
            <div class="value" id="nmCalls23Txt">29,977</div>
            <div class="year">2023</div>
          </div>
          <div class="metric">
            <div class="metric-title"><i class="fas fa-phone"></i> Crisis Calls</div>
            <div class="value" id="nmCalls24Txt">28,137</div>
            <div class="year">2024</div>
          </div>
        </div>

        <div class="rate-container">
          <div class="rate" id="nmRate23" style="background:#3498db;color:#fff">1.42% (2023)</div>
          <div class="rate" id="nmRate24" style="background:#3498db;color:#fff">1.32% (2024)</div>
          <div class="trend" id="nmTrend"><i class="fas fa-arrow-down"></i> <span>Decreased from 2023 to 2024</span></div>
        </div>
      </div>

      <!-- Table -->
      <table class="data-table" id="summaryTable">
        <thead>
          <tr>
            <th>Metric</th>
            <th colspan="2">2023</th>
            <th colspan="2">2024</th>
          </tr>
          <tr>
            <th>Name</th>
            <th id="thBR23">BR3</th>
            <th>New Mexico</th>
            <th id="thBR24">BR3</th>
            <th>New Mexico</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Crisis Calls</td>
            <td class="br-cell" id="tblBrCalls23" style="background:rgba(127,140,141,.10)">1,831</td>
            <td class="nm-cell" id="tblNmCalls23" style="background:rgba(52,152,219,.10)">29,977</td>
            <td class="br-cell" id="tblBrCalls24" style="background:rgba(127,140,141,.10)">1,733</td>
            <td class="nm-cell" id="tblNmCalls24" style="background:rgba(52,152,219,.10)">28,137</td>
          </tr>
          <tr>
            <td>Total Population</td>
            <td class="br-cell" id="tblBrPop23" style="background:rgba(127,140,141,.10)">225,210</td>
            <td class="nm-cell" id="tblNmPop23" style="background:rgba(52,152,219,.10)">2,117,522</td>
            <td class="br-cell" id="tblBrPop24" style="background:rgba(127,140,141,.10)">229,366</td>
            <td class="nm-cell" id="tblNmPop24" style="background:rgba(52,152,219,.10)">2,130,256</td>
          </tr>
          <tr>
            <td>Crisis Rate (%)</td>
            <td class="br-cell" id="tblBrRate23" style="background:rgba(127,140,141,.10)">0.81%</td>
            <td class="nm-cell" id="tblNmRate23" style="background:rgba(52,152,219,.10)">1.42%</td>
            <td class="br-cell" id="tblBrRate24" style="background:rgba(127,140,141,.10)">0.76%</td>
            <td class="nm-cell" id="tblNmRate24" style="background:rgba(52,152,219,.10)">1.32%</td>
          </tr>
        </tbody>
      </table>

      <!-- YoY -->
      <div class="data-highlight">
        <h3><i class="fas fa-chart-line"></i> Year-over-Year Changes</h3>
        <p id="yoyText">BR3 crisis calls decreased by <strong>5.3%</strong> (1,831 → 1,733) while New Mexico decreased by <strong>6.1%</strong> (29,977 → 28,137).</p>
      </div>

      <!-- Static bars (auto-scaled in JS) -->
      <div class="comparison">
        <h2><i class="fas fa-chart-bar"></i> Comparative Analysis</h2>

        <div class="chart-container">
          <div class="chart">
            <div class="chart-title">Crisis Call Rates Comparison (%)</div>

            <div id="lblBrRate23">BR3 2023: 0.81%</div>
            <div class="bar-container">
              <div class="bar" id="barBrRate23" style="width:32%;background:#7f8c8d">0.81%</div>
            </div>

            <div id="lblBrRate24">BR3 2024: 0.76%</div>
            <div class="bar-container">
              <div class="bar" id="barBrRate24" style="width:30%;background:#7f8c8d">0.76%</div>
            </div>

            <div id="lblNmRate23">NM 2023: 1.42%</div>
            <div class="bar-container">
              <div class="bar" id="barNmRate23" style="width:57%;background:#3498db">1.42%</div>
            </div>

            <div id="lblNmRate24">NM 2024: 1.32%</div>
            <div class="bar-container">
              <div class="bar" id="barNmRate24" style="width:53%;background:#3498db">1.32%</div>
            </div>
          </div>

          <div class="chart">
            <div class="chart-title">Total Crisis Calls Volume</div>

            <div id="lblBrCalls23">BR3 2023: 1,831</div>
            <div class="bar-container">
              <div class="bar" id="barBrCalls23" style="width:12%;background:#7f8c8d">1,831</div>
            </div>

            <div id="lblBrCalls24">BR3 2024: 1,733</div>
            <div class="bar-container">
              <div class="bar" id="barBrCalls24" style="width:11%;background:#7f8c8d">1,733</div>
            </div>

            <div id="lblNmCalls23">NM 2023: 29,977</div>
            <div class="bar-container">
              <div class="bar" id="barNmCalls23" style="width:70%;background:#3498db">29,977</div>
            </div>

            <div id="lblNmCalls24">NM 2024: 28,137</div>
            <div class="bar-container">
              <div class="bar" id="barNmCalls24" style="width:66%;background:#3498db">28,137</div>
            </div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="color-box" id="legendBrBox" style="background:#7f8c8d"></div>
            <span id="legendBrName">BR3 Service Area</span>
          </div>
          <div class="legend-item">
            <div class="color-box" id="legendNmBox" style="background:#3498db"></div>
            <span>New Mexico</span>
          </div>
        </div>
      </div>

      <div class="key-takeaway">
        <h3><i class="fas fa-lightbulb"></i> Key Insights</h3>
        <ul id="insightsList">
          <li>New Mexico handles the larger total volume of calls, but both areas saw year-over-year decreases.</li>
          <li><span id="insBrName">BR3</span> crisis rate dipped in 2024, and New Mexico’s rate also decreased.</li>
          <li>Populations increased slightly in both <span id="insBrName2">BR3</span> and the state overall between 2023 and 2024.</li>
        </ul>
      </div>

      <footer>
        <p>Source: Provided Crisis Call Data, 2023–2024 | Visualization designed for comparative analysis</p>
      </footer>
    </div>
  </div>

<script>
  // --------- Utilities ---------
  const fmtInt = n => Number(n).toLocaleString('en-US');
  const pct = (num, den) => den ? (100 * num / den) : 0;
  const fmtPct = v => (Math.round(v * 100) / 100).toFixed(2) + '%';

  // Color helpers
  function normalizeHex(v){
    if(!v) return null;
    v = v.trim();
    if(v[0] !== '#') v = '#'+v;
    if(/^#([0-9A-Fa-f]{6})$/.test(v)) return v.toUpperCase();
    if(/^#([0-9A-Fa-f]{3})$/.test(v)){
      const c = v.slice(1).split('').map(x=>x+x).join('');
      return ('#'+c).toUpperCase();
    }
    return null;
  }
  function hexToRgb(hex){
    const h = normalizeHex(hex);
    if(!h) return null;
    const v = h.slice(1);
    const r = parseInt(v.slice(0,2),16);
    const g = parseInt(v.slice(2,4),16);
    const b = parseInt(v.slice(4,6),16);
    return {r,g,b};
  }
  function rgba(hex, a){
    const c = hexToRgb(hex);
    return c ? `rgba(${c.r},${c.g},${c.b},${a})` : 'rgba(0,0,0,0.1)';
  }
  function rgbToHex(r,g,b){
    const to2 = v => v.toString(16).padStart(2,'0');
    return ('#'+to2(r)+to2(g)+to2(b)).toUpperCase();
  }
  function lightenHex(hex, pct){
    // pct in [0..1] — 0 = no change, 1 = white
    const c = hexToRgb(hex); if(!c) return '#FFFFFF';
    const r = Math.round(c.r + (255 - c.r) * pct);
    const g = Math.round(c.g + (255 - c.g) * pct);
    const b = Math.round(c.b + (255 - c.b) * pct);
    return rgbToHex(r,g,b);
  }

  function getInputs(){
    return {
      brName: document.getElementById('brName').value.trim() || 'BR',
      brPop23: +document.getElementById('brPop23').value,
      brCalls23: +document.getElementById('brCalls23').value,
      brPop24: +document.getElementById('brPop24').value,
      brCalls24: +document.getElementById('brCalls24').value,
      nmPop23: +document.getElementById('nmPop23').value,
      nmCalls23: +document.getElementById('nmCalls23').value,
      nmPop24: +document.getElementById('nmPop24').value,
      nmCalls24: +document.getElementById('nmCalls24').value,
      minBarPct: Math.max(0, Math.min(30, +document.getElementById('minBarPct').value || 0)),
    };
  }

  function getColors(){
    return {
      brColor: normalizeHex(document.getElementById('brColorHex').value) || normalizeHex(document.getElementById('brColor').value) || '#7F8C8D',
      nmColor: normalizeHex(document.getElementById('nmColorHex').value) || normalizeHex(document.getElementById('nmColor').value) || '#3498DB',
    };
  }

  // ---- APPLY NUMBERS/TEXT ----
  function apply(){
    const d = getInputs();

    // Derived
    const brRate23 = pct(d.brCalls23, d.brPop23);
    const brRate24 = pct(d.brCalls24, d.brPop24);
    const nmRate23 = pct(d.nmCalls23, d.nmPop23);
    const nmRate24 = pct(d.nmCalls24, d.nmPop24);

    // Titles / labels
    document.getElementById('pageTitle').innerHTML = `Crisis Call Rates: <span id="brNameTitle">${d.brName}</span> vs. New Mexico`;
    document.getElementById('brNameLbl').textContent = d.brName;
    document.getElementById('brNameLbl2').textContent = d.brName;
    document.getElementById('brNameCard').textContent = d.brName;
    document.getElementById('legendBrName').textContent = `${d.brName} Service Area`;
    document.getElementById('insBrName').textContent = d.brName;
    document.getElementById('insBrName2').textContent = d.brName;
    document.getElementById('thBR23').textContent = d.brName;
    document.getElementById('thBR24').textContent = d.brName;

    // BR metrics
    document.getElementById('brPop23Txt').textContent = fmtInt(d.brPop23);
    document.getElementById('brPop24Txt').textContent = fmtInt(d.brPop24);
    document.getElementById('brCalls23Txt').textContent = fmtInt(d.brCalls23);
    document.getElementById('brCalls24Txt').textContent = fmtInt(d.brCalls24);
    document.getElementById('brRate23').textContent = `${fmtPct(brRate23)} (2023)`;
    document.getElementById('brRate24').textContent = `${fmtPct(brRate24)} (2024)`;

    // NM metrics
    document.getElementById('nmPop23Txt').textContent = fmtInt(d.nmPop23);
    document.getElementById('nmPop24Txt').textContent = fmtInt(d.nmPop24);
    document.getElementById('nmCalls23Txt').textContent = fmtInt(d.nmCalls23);
    document.getElementById('nmCalls24Txt').textContent = fmtInt(d.nmCalls24);
    document.getElementById('nmRate23').textContent = `${fmtPct(nmRate23)} (2023)`;
    document.getElementById('nmRate24').textContent = `${fmtPct(nmRate24)} (2024)`;

    // Table values
    document.getElementById('tblBrCalls23').textContent = fmtInt(d.brCalls23);
    document.getElementById('tblBrCalls24').textContent = fmtInt(d.brCalls24);
    document.getElementById('tblNmCalls23').textContent = fmtInt(d.nmCalls23);
    document.getElementById('tblNmCalls24').textContent = fmtInt(d.nmCalls24);

    document.getElementById('tblBrPop23').textContent = fmtInt(d.brPop23);
    document.getElementById('tblBrPop24').textContent = fmtInt(d.brPop24);
    document.getElementById('tblNmPop23').textContent = fmtInt(d.nmPop23);
    document.getElementById('tblNmPop24').textContent = fmtInt(d.nmPop24);

    document.getElementById('tblBrRate23').textContent = fmtPct(brRate23);
    document.getElementById('tblBrRate24').textContent = fmtPct(brRate24);
    document.getElementById('tblNmRate23').textContent = fmtPct(nmRate23);
    document.getElementById('tblNmRate24').textContent = fmtPct(nmRate24);

    // Trends text
    const brYoY = d.brCalls24 - d.brCalls23;
    const nmYoY = d.nmCalls24 - d.nmCalls23;
    const brPctYoY = d.brCalls23 ? (brYoY / d.brCalls23 * 100) : 0;
    const nmPctYoY = d.nmCalls23 ? (nmYoY / d.nmCalls23 * 100) : 0;

    document.getElementById('brTrend').innerHTML =
      `${brYoY < 0 ? '<i class="fas fa-arrow-down"></i>' : (brYoY > 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-minus"></i>')}
       <span>${brYoY < 0 ? 'Decreased' : (brYoY > 0 ? 'Increased' : 'No change')} from 2023 to 2024</span>`;

    document.getElementById('nmTrend').innerHTML =
      `${nmYoY < 0 ? '<i class="fas fa-arrow-down"></i>' : (nmYoY > 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-minus"></i>')}
       <span>${nmYoY < 0 ? 'Decreased' : (nmYoY > 0 ? 'Increased' : 'No change')} from 2023 to 2024</span>`;

    const yoyText = `${d.brName} crisis calls ${brYoY < 0 ? 'decreased' : (brYoY > 0 ? 'increased' : 'were unchanged')} by <strong>${Math.abs(brPctYoY).toFixed(1)}%</strong> (${fmtInt(d.brCalls23)} → ${fmtInt(d.brCalls24)}) while New Mexico ${nmYoY < 0 ? 'decreased' : (nmYoY > 0 ? 'increased' : 'was unchanged')} by <strong>${Math.abs(nmPctYoY).toFixed(1)}%</strong> (${fmtInt(d.nmCalls23)} → ${fmtInt(d.nmCalls24)}).`;
    document.getElementById('yoyText').innerHTML = yoyText;

    // Bars widths only (keep existing colors; color button will recolor)
    const minPct = Math.max(0, Math.min(30, +document.getElementById('minBarPct').value || 0));

    const rateVals = [brRate23, brRate24, nmRate23, nmRate24];
    const rateMax = Math.max(...rateVals, 1e-9);
    setBarWidth('barBrRate23', brRate23, rateMax, minPct, fmtPct(brRate23));
    setBarWidth('barBrRate24', brRate24, rateMax, minPct, fmtPct(brRate24));
    setBarWidth('barNmRate23', nmRate23, rateMax, minPct, fmtPct(nmRate23));
    setBarWidth('barNmRate24', nmRate24, rateMax, minPct, fmtPct(nmRate24));

    const callVals = [d.brCalls23, d.brCalls24, d.nmCalls23, d.nmCalls24];
    const callsMax = Math.max(...callVals, 1);
    setBarWidth('barBrCalls23', d.brCalls23, callsMax, minPct, fmtInt(d.brCalls23));
    setBarWidth('barBrCalls24', d.brCalls24, callsMax, minPct, fmtInt(d.brCalls24));
    setBarWidth('barNmCalls23', d.nmCalls23, callsMax, minPct, fmtInt(d.nmCalls23));
    setBarWidth('barNmCalls24', d.nmCalls24, callsMax, minPct, fmtInt(d.nmCalls24));

    // Labels for charts (text only)
    document.getElementById('lblBrRate23').textContent = `${d.brName} 2023: ${fmtPct(brRate23)}`;
    document.getElementById('lblBrRate24').textContent = `${d.brName} 2024: ${fmtPct(brRate24)}`;
    document.getElementById('lblNmRate23').textContent = `NM 2023: ${fmtPct(nmRate23)}`;
    document.getElementById('lblNmRate24').textContent = `NM 2024: ${fmtPct(nmRate24)}`;
    document.getElementById('lblBrCalls23').textContent = `${d.brName} 2023: ${fmtInt(d.brCalls23)}`;
    document.getElementById('lblBrCalls24').textContent = `${d.brName} 2024: ${fmtInt(d.brCalls24)}`;
    document.getElementById('lblNmCalls23').textContent = `NM 2023: ${fmtInt(d.nmCalls23)}`;
    document.getElementById('lblNmCalls24').textContent = `NM 2024: ${fmtInt(d.nmCalls24)}`;
  }

  function setBarWidth(id, val, vmax, minPct, label){
    const el = document.getElementById(id);
    const pctW = Math.max(minPct, (val / vmax) * 100);
    el.style.width = Math.min(100, pctW).toFixed(1) + '%';
    el.textContent = label;
  }

  // ---- APPLY COLORS ONLY (includes BR card background theming) ----
  function applyColors(){
    const { brColor, nmColor } = getColors();

    // Sync pickers <-> hex inputs and swatches
    const setColorUI = (hex, pickId, hexId, swatchId) => {
      const pick = document.getElementById(pickId);
      const hexEl = document.getElementById(hexId);
      const sw = document.getElementById(swatchId);
      hexEl.value = hex;
      pick.value = hex;
      hexEl.classList.remove('input-invalid');
      sw.style.background = hex;
    };
    setColorUI(brColor, 'brColor', 'brColorHex', 'brSwatch');
    setColorUI(nmColor, 'nmColor', 'nmColorHex', 'nmSwatch');

    // Cards & rate badges
    document.getElementById('brCard').style.borderLeftColor = brColor;
    document.getElementById('nmCard').style.borderLeftColor = nmColor;
    document.getElementById('brRate23').style.background = brColor;
    document.getElementById('brRate24').style.background = brColor;
    document.getElementById('nmRate23').style.background = nmColor;
    document.getElementById('nmRate24').style.background = nmColor;

    // NEW: BR card background follows BR color (soft gradient)
    const brBg1 = lightenHex(brColor, 0.82);  // closer to base
    const brBg2 = lightenHex(brColor, 0.93);  // closer to white
    const brCard = document.getElementById('brCard');
    brCard.style.background = `linear-gradient(135deg, ${brBg1} 0%, ${brBg2} 100%)`;

    // OPTIONAL: NM card gradient (uncomment to theme NM panel too)
    // const nmBg1 = lightenHex(nmColor, 0.82);
    // const nmBg2 = lightenHex(nmColor, 0.93);
    // const nmCard = document.getElementById('nmCard');
    // nmCard.style.background = `linear-gradient(135deg, ${nmBg1} 0%, ${nmBg2} 100%)`;

    // Legend
    document.getElementById('legendBrBox').style.background = brColor;
    document.getElementById('legendNmBox').style.background = nmColor;

    // Bars: recolor only (keep current widths)
    ['barBrRate23','barBrRate24','barBrCalls23','barBrCalls24'].forEach(id=>{
      document.getElementById(id).style.background = brColor;
    });
    ['barNmRate23','barNmRate24','barNmCalls23','barNmCalls24'].forEach(id=>{
      document.getElementById(id).style.background = nmColor;
    });

    // Table cell tints
    const brTint = rgba(brColor, .10);
    const nmTint = rgba(nmColor, .10);
    ['tblBrCalls23','tblBrCalls24','tblBrPop23','tblBrPop24','tblBrRate23','tblBrRate24'].forEach(id=>{
      document.getElementById(id).style.background = brTint;
    });
    ['tblNmCalls23','tblNmCalls24','tblNmPop23','tblNmPop24','tblNmRate23','tblNmRate24'].forEach(id=>{
      document.getElementById(id).style.background = nmTint;
    });
  }

  // Color field validation (typing only)
  function previewHexField(el){
    const good = normalizeHex(el.value);
    if(good){ el.classList.remove('input-invalid'); }
    else{ el.classList.add('input-invalid'); }
  }

  // Buttons
  document.getElementById('applyBtn').addEventListener('click', apply);
  document.getElementById('applyColorsBtn').addEventListener('click', applyColors);

  // Auto-apply numbers/text (exclude color fields)
  Array.from(document.querySelectorAll('.customizer input'))
    .filter(inp => !['brColor','nmColor','brColorHex','nmColorHex'].includes(inp.id))
    .forEach(inp => {
      inp.addEventListener('change', apply);
      inp.addEventListener('keyup', e => { if(e.key==='Enter') apply(); });
    });

  // Color fields: validate typing
  document.getElementById('brColorHex').addEventListener('input', e => previewHexField(e.target));
  document.getElementById('nmColorHex').addEventListener('input', e => previewHexField(e.target));

  // Initial render
  apply();
  applyColors();
</script>
</body>
</html>

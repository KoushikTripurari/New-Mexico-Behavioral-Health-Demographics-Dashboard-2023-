<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NM BR — Race/Ethnicity • Age • Gender</title>

<link rel="preconnect" href="https://api.census.gov">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

<style>
  :root{--ink:#0b2233;--muted:#64748b;--brand:#2563eb;--ring:rgba(37,99,235,.25);
        --female:#f7a8c6;--male:#2fb4ef}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:linear-gradient(180deg,#f5f7fb,#eef2f8);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid #e6eaf2;padding:12px 16px}
  h1{margin:0;font-size:clamp(18px,2.6vw,22px)}
  .wrap{max-width:1200px;margin:14px auto;padding:0 16px}
  .card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:16px;margin-bottom:14px}
  .row{display:grid;gap:12px}
  .row.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:950px){.row.cols-4{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.row.cols-4{grid-template-columns:1fr}}
  label{display:block;font-weight:700;margin:6px 0}
  input[type="text"],select,input[type="file"],input[type="number"],input[type="range"]{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:10px;outline:0}
  input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.secondary{background:#64748b}
  .note{color:#64748b;font-size:.95rem}
  .error{color:#b91c1c}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){.grid2{grid-template-columns:1fr}}
  .canvasBox{background:radial-gradient(circle at 30% 20%, #ffffff 0, #f1f5fb 70%);border-radius:14px;padding:10px;box-shadow:inset 0 1px 0 #fff}
  .title{font-weight:800;text-align:center;margin:8px 0 4px;font-size:22px}

  /* Excel-like tables */
  .tableBox{overflow:auto;border:1px solid #e6eaf2;border-radius:12px}
  table.comp{width:100%;border-collapse:collapse;background:#fafafa}
  table.comp th, table.comp td{border:1px solid #cfd8e3;padding:12px 10px;font-size:14px}
  table.comp thead th{background:#f1f5fb;color:#111827;text-align:center;font-weight:800}
  table.comp tbody td:first-child{font-weight:700}
  table.comp td.num{text-align:right;font-variant-numeric:tabular-nums}

  /* Gender panel (kept for on-page viewing) */
  .panel{position:relative;display:grid;grid-template-columns:1fr 1fr;gap:0;border-radius:16px;overflow:hidden;border:1px solid #e5e7eb}
  .half{position:relative;min-height:220px;display:flex;align-items:center;justify-content:center}
  .female{background:linear-gradient(180deg,#ffd9e6 0%, var(--female) 100%)}
  .male{background:linear-gradient(180deg,#cfefff 0%, var(--male) 100%)}
  .icon{font-size:96px;opacity:.22;color:#000;position:absolute}
  .big{font-size:68px;font-weight:900;letter-spacing:.3px;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.25)}
  .labels{position:absolute;bottom:12px;left:12px;color:#111;font-weight:800;text-shadow:0 1px 0 #fff}
  .labels small{display:block;font-weight:800}

  /* Silhouette image controls */
  .ctl-grid{display:grid;grid-template-columns:repeat(6,minmax(100px,1fr));gap:10px;margin:10px 0}
  @media (max-width:900px){.ctl-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>New Mexico — Behavioral Region Race/Ethnicity, Age, and Gender</h1>
    <div class="note">Race/Ethnicity: ACS 5-year B03002 • Age & Gender: ACS 5-year B01001. BR values are population-weighted from county counts.</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row cols-4">
      <div>
        <label for="year">ACS Year (5-year)</label>
        <select id="year">
          <option value="2023" selected>2023 (2019–2023)</option>
          <option value="2022">2022 (2018–2022)</option>
          <option value="2021">2021 (2017–2021)</option>
          <option value="2020">2020 (2016–2020)</option>
        </select>
      </div>
      <div>
        <label for="br">Behavioral Region</label>
        <select id="br">
          <option value="BR1">BR1</option><option value="BR2">BR2</option><option value="BR3" selected>BR3</option>
          <option value="BR4">BR4</option><option value="BR5">BR5</option><option value="BR6">BR6</option>
          <option value="BR7">BR7</option><option value="BR8">BR8</option><option value="BR9">BR9</option>
          <option value="BR10">BR10</option><option value="BR11">BR11</option><option value="BR12">BR12</option><option value="BR13">BR13</option>
        </select>
      </div>
      <div>
        <label for="apikey">Census API Key (optional)</label>
        <input id="apikey" type="text" placeholder="Paste key (saved locally)">
      </div>
      <div style="display:flex;align-items:flex-end;gap:10px">
        <button id="fetchBtn" class="btn">Fetch ACS</button>
        <button id="pngNm" class="btn secondary">Download NM Pie</button>
        <button id="pngBr" class="btn secondary">Download BR Pie</button>
      </div>
    </div>

    <div class="controls" style="margin-top:8px">
      <input id="file" type="file" accept=".xlsx,.xls,.csv">
      <span class="note">Optional file to override race/ethnicity pies: headers <b>County, Total, AIAN_nonHisp, Hispanic, NH_Black, NH_White</b>. “Others” is computed.</span>
      <span id="status" class="note"></span>
      <span id="err" class="note error"></span>
    </div>
  </div>

  <!-- Race pies -->
  <div class="grid2">
    <div class="card">
      <div class="title">New Mexico — Race/Ethnicity (%)</div>
      <div class="canvasBox"><canvas id="nmChart" height="360"></canvas></div>
    </div>

    <div class="card">
      <div class="title" id="brTitle">Behavioral Region 3 — Race/Ethnicity (%)</div>
      <div class="canvasBox"><canvas id="brChart" height="360"></canvas></div>
    </div>
  </div>

  <!-- Race/Ethnicity table -->
  <div class="card">
    <div class="title" id="tblTitleRace">Race/Ethnicity — New Mexico vs. Behavioral Region 3</div>
    <div class="tableBox">
      <table class="comp">
        <thead>
          <tr>
            <th>Race/Ethnicity</th>
            <th>New Mexico (%)</th>
            <th id="thBrRace">Behavioral Region 3 (%)</th>
          </tr>
        </thead>
        <tbody id="tbodyRace"></tbody>
      </table>
    </div>
  </div>

  <!-- Age table -->
  <div class="card">
    <div class="title" id="tblTitleAge">Age Group — New Mexico vs. Behavioral Region 3</div>
    <div class="tableBox">
      <table class="comp">
        <thead>
          <tr>
            <th>Age Group</th>
            <th>New Mexico (%)</th>
            <th id="thBrAge">Behavioral Region 3 (%)</th>
          </tr>
        </thead>
        <tbody id="tbodyAge">
          <tr><td>Under 18 years</td><td class="num">–</td><td class="num">–</td></tr>
          <tr><td>18 years and over</td><td class="num">–</td><td class="num">–</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Gender panel + table (on-page view) -->
  <div class="grid2">
    <div class="card">
      <div class="title">Gender</div>
      <div class="panel">
        <!-- Female -->
        <div class="half female">
          <div class="icon">♀</div>
          <div class="big" id="femalePct">–%</div>
          <div class="labels">
            <div id="femaleState">Statewide — –%</div>
            <small id="femaleBR">BR-— —%</small>
          </div>
        </div>
        <!-- Male -->
        <div class="half male">
          <div class="icon">♂</div>
          <div class="big" id="malePct">–%</div>
          <div class="labels">
            <div id="maleState">Statewide — –%</div>
            <small id="maleBR">BR-— —%</small>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="title" id="tblTitleGender">Male / Female — New Mexico vs. Behavioral Region 3</div>
      <div class="tableBox">
        <table class="comp">
          <thead>
            <tr>
              <th>Sex</th>
              <th>New Mexico (%)</th>
              <th id="thBrGender">Behavioral Region 3 (%)</th>
            </tr>
          </thead>
          <tbody id="tbodyGender">
            <tr><td>Female</td><td class="num">–</td><td class="num">–</td></tr>
            <tr><td>Male</td>  <td class="num">–</td><td class="num">–</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Silhouette image with adjustable labels + download ===== -->
  <div class="card">
    <div class="title">Gender Silhouette Image — Overlay Labels & Download</div>

    <div class="ctl-grid">
      <div>
        <label>Left X</label>
        <input id="lx" type="number" value="120">
      </div>
      <div>
        <label>Left Y</label>
        <input id="ly" type="number" value="470">
      </div>
      <div>
        <label>Right X</label>
        <input id="rx" type="number" value="800">
      </div>
      <div>
        <label>Right Y</label>
        <input id="ry" type="number" value="470">
      </div>
      <div>
        <label>Font size</label>
        <input id="fsize" type="number" value="48" min="18" max="96">
      </div>
      <div>
        <label>Upload image (optional)</label>
        <input id="bgUpload" type="file" accept="image/*">
      </div>
    </div>

    <div class="canvasBox">
      <!-- Use your own gender_bg.png in same folder (or upload). -->
      <canvas id="genderCanvas" width="1280" height="640" style="width:100%;height:auto;display:block;border-radius:10px"></canvas>
    </div>

    <div class="controls" style="margin-top:10px">
      <button id="downloadGender" class="btn">Download Gender Image</button>
      <span class="note">Tip: tweak X/Y to move the black text blocks. The labels update automatically when you change the Behavioral Region.</span>
    </div>
  </div>
</div>

<script>
Chart.register(ChartDataLabels);

/* ---------- Constants & helpers ---------- */
const COLORS = { AIAN:'#00A3FF', HISP:'#FF2DA1', NHB:'#1FBF53', NHW:'#FFF200', OTH:'#6A46C1' };
const LABELS = [
  'AIAN (American Indian/Alaska Native)',
  'Hispanic','Non-Hispanic Black','Non-Hispanic White','Others'
];
const ORDER = ['aian','hisp','nhb','nhw','others'];
const COLORS_ORDER = [COLORS.AIAN,COLORS.HISP,COLORS.NHB,COLORS.NHW,COLORS.OTH];

const BR_MAP = {
  BR1:["Los Alamos","Rio Arriba","Santa Fe"],
  BR2:["Bernalillo"],
  BR3:["Doña Ana","Dona Ana"],
  BR4:["Guadalupe","Mora","San Miguel"],
  BR5:["Chaves","Eddy","Lea"],
  BR6:["Grant","Hidalgo","Luna"],
  BR7:["Catron","Socorro","Sierra","Torrance"],
  BR8:["Taos","Colfax","Union"],
  BR9:["Curry","Roosevelt"],
  BR10:["De Baca","DeBaca","Harding","Quay"],
  BR11:["McKinley","San Juan"],
  BR12:["Lincoln","Otero"],
  BR13:["Cibola","Sandoval","Valencia"]
};

const $ = s => document.querySelector(s);
const pct = (n,d)=> d? (n/d*100):0;
const pct1 = v => (Math.round(v*10)/10).toFixed(1);
const pct2 = v => (Math.round(v*100)/100).toFixed(2);

/* ---------- Stores ---------- */
let countyRaceRows = []; // {county,total,aian,hisp,nhb,nhw,others}
let countyAgeRows  = []; // {county,total,u18,o18}
let countySexRows  = []; // {county,total,male,female}
let stateAge       = { total:0, u18:0, o18:0 };
let stateSex       = { total:0, male:0, female:0 };

/* ---------- Charts ---------- */
let nmChart, brChart;
function makePie(ctx){
  return new Chart(ctx, {
    type:'pie',
    data:{ labels: LABELS, datasets:[{ data:[0,0,0,0,0], backgroundColor: COLORS_ORDER, borderColor:'#fff', borderWidth:2, hoverOffset:6 }]},
    options:{
      plugins:{
        legend:{ position:'right', labels:{ usePointStyle:true, boxWidth:10 }},
        datalabels:{
          formatter:(v)=> v>0? `${pct2(v)}%`:'', color:'#fff',
          font:{weight:'700'}, backgroundColor:'rgba(0,0,0,.55)',
          borderRadius:6, padding:6, display:(ctx)=> ctx.dataset.data[ctx.dataIndex] >= 0.5
        }
      }, layout:{ padding:8 }
    }
  });
}

/* ---------- Race helpers ---------- */
function nmTotalsRace(rows){
  const sum = k => rows.reduce((a,r)=>a+(r[k]||0),0);
  const total=sum('total'), aian=sum('aian'), hisp=sum('hisp'), nhb=sum('nhb'), nhw=sum('nhw');
  const others = Math.max(0,total-(aian+hisp+nhb+nhw));
  return {total,aian,hisp,nhb,nhw,others};
}
function brTotalsRace(rows, br){
  const set = new Set(BR_MAP[br]||[]);
  return nmTotalsRace(rows.filter(r=> set.has(r.county)));
}
function renderRace(){
  const br = $('#br').value, brNo = br.replace('BR','');
  $('#brTitle').textContent   = `Behavioral Region ${brNo} — Race/Ethnicity (%)`;
  $('#tblTitleRace').textContent = `Race/Ethnicity — New Mexico vs. Behavioral Region ${brNo}`;
  $('#thBrRace').textContent  = `Behavioral Region ${brNo} (%)`;

  const nm = nmTotalsRace(countyRaceRows);
  const brv = brTotalsRace(countyRaceRows, br);

  const nmPerc = ORDER.map(k => pct(nm[k], nm.total));
  const brPerc = ORDER.map(k => pct(brv[k], brv.total));

  nmChart.data.datasets[0].data = nmPerc;
  brChart.data.datasets[0].data = brPerc;
  nmChart.update(); brChart.update();

  const tb = $('#tbodyRace'); tb.innerHTML='';
  LABELS.forEach((lbl,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${lbl}</td><td class="num">${pct2(nmPerc[i])}</td><td class="num">${pct2(brPerc[i])}</td>`;
    tb.appendChild(tr);
  });
}

/* ---------- Age table ---------- */
function renderAge(){
  const br = $('#br').value, brNo = br.replace('BR','');
  $('#tblTitleAge').textContent = `Age Group — New Mexico vs. Behavioral Region ${brNo}`;
  $('#thBrAge').textContent = `Behavioral Region ${brNo} (%)`;

  const nmU18 = pct(stateAge.u18, stateAge.total);
  const nmO18 = pct(stateAge.o18, stateAge.total);

  const set = new Set(BR_MAP[br]||[]);
  const sub = countyAgeRows.filter(r=> set.has(r.county));
  const tot = sub.reduce((a,r)=>a+r.total,0);
  const u18 = sub.reduce((a,r)=>a+r.u18,0);
  const o18 = sub.reduce((a,r)=>a+r.o18,0);
  const brU18 = pct(u18, tot), brO18 = pct(o18, tot);

  $('#tbodyAge').innerHTML = `
    <tr><td>Under 18 years</td><td class="num">${pct2(nmU18)}</td><td class="num">${pct2(brU18)}</td></tr>
    <tr><td>18 years and over</td><td class="num">${pct2(nmO18)}</td><td class="num">${pct2(brO18)}</td></tr>
  `;
}

/* ========== Gender panel, table, and SILHOUETTE IMAGE overlay ========== */
const genderCanvas = document.getElementById('genderCanvas');
const gctx = genderCanvas.getContext('2d');
const genderBG = new Image();
genderBG.crossOrigin = 'anonymous'; // helpful when hosted
let genderBGReady = false;

// default image path (put gender_bg.png next to this HTML)
genderBG.src = 'https://github.com/KoushikTripurari/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/blob/main/Gender_image.png';


genderBG.onload = ()=>{ genderBGReady = true; drawGenderOverlay(); };

/* Live controls */
['lx','ly','rx','ry','fsize'].forEach(id=>{
  document.getElementById(id).addEventListener('input', drawGenderOverlay);
});
document.getElementById('bgUpload').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => { genderBG.src = ev.target.result; };
  reader.readAsDataURL(f);
});
document.getElementById('downloadGender').addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = genderCanvas.toDataURL('image/png');
  const br = document.getElementById('br').value.replace('BR','BR-');
  a.download = `Gender_${br}.png`;
  a.click();
});

/* Values shown in overlay — kept in this object and updated by renderGender() */
let genderOverlayText = {
  leftLine1: 'Statewide — –%',
  leftLine2: 'BR-— —%',
  rightLine1:'Statewide — –%',
  rightLine2:'BR-— —%'
};

function drawGenderOverlay(){
  if(!genderBGReady) return;

  // Fit background image to canvas
  gctx.clearRect(0,0,genderCanvas.width,genderCanvas.height);
  gctx.drawImage(genderBG, 0, 0, genderCanvas.width, genderCanvas.height);

  const lx = +document.getElementById('lx').value || 120;
  const ly = +document.getElementById('ly').value || 470;
  const rx = +document.getElementById('rx').value || 800;
  const ry = +document.getElementById('ry').value || 470;
  const fs = +document.getElementById('fsize').value || 48;
  const lineGap = Math.round(fs * 0.95);

  gctx.fillStyle = '#111111';
  gctx.font = `800 ${fs}px ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial`;
  gctx.textBaseline = 'alphabetic';

  // Left (Female)
  gctx.fillText(genderOverlayText.leftLine1, lx, ly);
  gctx.fillText(genderOverlayText.leftLine2, lx, ly + lineGap);

  // Right (Male)
  gctx.fillText(genderOverlayText.rightLine1, rx, ry);
  gctx.fillText(genderOverlayText.rightLine2, rx, ry + lineGap);
}

function renderGender(){
  const br = $('#br').value, brNo = br.replace('BR','');
  $('#tblTitleGender').textContent = `Male / Female — New Mexico vs. Behavioral Region ${brNo}`;
  $('#thBrGender').textContent = `Behavioral Region ${brNo} (%)`;

  const nmMalePct   = pct(stateSex.male, stateSex.total);
  const nmFemalePct = pct(stateSex.female, stateSex.total);

  const set = new Set(BR_MAP[br]||[]);
  const sub = countySexRows.filter(r=> set.has(r.county));
  const tot = sub.reduce((a,r)=>a+r.total,0);
  const male = sub.reduce((a,r)=>a+r.male,0);
  const female = sub.reduce((a,r)=>a+r.female,0);
  const brMalePct   = pct(male, tot);
  const brFemalePct = pct(female, tot);

  // Table
  $('#tbodyGender').innerHTML = `
    <tr><td>Female</td><td class="num">${pct1(nmFemalePct)}</td><td class="num">${pct1(brFemalePct)}</td></tr>
    <tr><td>Male</td>  <td class="num">${pct1(nmMalePct)}</td>  <td class="num">${pct1(brMalePct)}</td></tr>
  `;

  // Panel labels (kept)
  $('#femalePct').textContent  = `${pct1(brFemalePct)}%`;
  $('#malePct').textContent    = `${pct1(brMalePct)}%`;
  $('#femaleState').textContent= `Statewide — ${pct1(nmFemalePct)}%`;
  $('#femaleBR').textContent   = `${br.replace('BR','BR-')} — ${pct1(brFemalePct)}%`;
  $('#maleState').textContent  = `Statewide — ${pct1(nmMalePct)}%`;
  $('#maleBR').textContent     = `${br.replace('BR','BR-')} — ${pct1(brMalePct)}%`;

  // ===== Update the silhouette overlay text (BLACK TEXT on your image) =====
  genderOverlayText.leftLine1  = `Statewide — ${pct1(nmFemalePct)}%`;
  genderOverlayText.leftLine2  = `${br.replace('BR','BR-')} — ${pct1(brFemalePct)}%`;
  genderOverlayText.rightLine1 = `Statewide — ${pct1(nmMalePct)}%`;
  genderOverlayText.rightLine2 = `${br.replace('BR','BR-')} — ${pct1(brMalePct)}%`;
  drawGenderOverlay();
}

/* ---------- Fetchers ---------- */
// Race (B03002)
function buildRaceUrl(year,key){
  const vars = ['NAME','B03002_001E','B03002_003E','B03002_004E','B03002_005E','B03002_012E'].join(',');
  let u = `https://api.census.gov/data/${year}/acs/acs5?get=${vars}&for=county:*&in=state:35`;
  if(key && key.trim()) u += `&key=${encodeURIComponent(key.trim())}`;
  return u;
}

// Age & Sex (B01001)
function buildAgeSexCountyUrl(year,key){
  const vars = [
    'NAME','B01001_001E','B01001_002E','B01001_026E',
    'B01001_003E','B01001_004E','B01001_005E','B01001_006E',
    'B01001_027E','B01001_028E','B01001_029E','B01001_030E'
  ].join(',');
  let u = `https://api.census.gov/data/${year}/acs/acs5?get=${vars}&for=county:*&in=state:35`;
  if(key && key.trim()) u += `&key=${encodeURIComponent(key.trim())}`;
  return u;
}
function buildAgeSexStateUrl(year,key){
  const vars = [
    'B01001_001E','B01001_002E','B01001_026E',
    'B01001_003E','B01001_004E','B01001_005E','B01001_006E',
    'B01001_027E','B01001_028E','B01001_029E','B01001_030E'
  ].join(',');
  let u = `https://api.census.gov/data/${year}/acs/acs5?get=${vars}&for=state:35`;
  if(key && key.trim()) u += `&key=${encodeURIComponent(key.trim())}`;
  return u;
}

async function fetchACS(){
  $('#status').textContent='Loading ACS…'; $('#err').textContent='';
  const year = $('#year').value;
  const key  = $('#apikey').value || localStorage.getItem('census_api_key') || '';
  if($('#apikey').value) localStorage.setItem('census_api_key',$('#apikey').value.trim());

  try{
    const [raceRes, countyRes, stateRes] = await Promise.all([
      fetch(buildRaceUrl(year,key), {cache:'no-store'}),
      fetch(buildAgeSexCountyUrl(year,key), {cache:'no-store'}),
      fetch(buildAgeSexStateUrl(year,key), {cache:'no-store'}),
    ]);

    const [raceTxt, countyTxt, stateTxt] = await Promise.all([raceRes.text(), countyRes.text(), stateRes.text()]);
    if(!raceRes.ok)  throw new Error(`Race HTTP ${raceRes.status} ${raceTxt}`);
    if(!countyRes.ok)throw new Error(`County B01001 HTTP ${countyRes.status} ${countyTxt}`);
    if(!stateRes.ok) throw new Error(`State B01001 HTTP ${stateRes.status} ${stateTxt}`);

    // Race rows
    const raceJson = JSON.parse(raceTxt);
    countyRaceRows = raceJson.slice(1).map(r=>{
      const county = r[0].replace(' County, New Mexico','');
      const total=+r[1], nhw=+r[2], nhb=+r[3], aian=+r[4], hisp=+r[5];
      return {county,total,aian,hisp,nhb,nhw,others:Math.max(0,total-(aian+hisp+nhb+nhw))};
    }).sort((a,b)=>a.county.localeCompare(b.county));

    // County age+sex rows
    const cj = JSON.parse(countyTxt);
    countyAgeRows = [];
    countySexRows = [];
    cj.slice(1).forEach(r=>{
      const county = r[0].replace(' County, New Mexico','');
      const total  = +r[1]||0;
      const male   = +r[2]||0;
      const female = +r[3]||0;
      const u18    = (+r[4]+ +r[5]+ +r[6]+ +r[7] + +r[8]+ +r[9]+ +r[10]+ +r[11]) || 0;
      const o18    = Math.max(0, total - u18);
      countyAgeRows.push({county,total,u18,o18});
      countySexRows.push({county,total,male,female});
    });

    // State age+sex counts
    const s = JSON.parse(stateTxt);
    stateSex = { total:+s[1][0]||0, male:+s[1][1]||0, female:+s[1][2]||0 };
    const stU18 = (+s[1][3]+ +s[1][4]+ +s[1][5]+ +s[1][6] + +s[1][7]+ +s[1][8]+ +s[1][9]+ +s[1][10]) || 0;
    const stO18 = Math.max(0, stateSex.total - stU18);
    stateAge = { total: stateSex.total, u18: stU18, o18: stO18 };

    renderRace();
    renderAge();
    renderGender();

    $('#status').textContent = `ACS ${year} loaded (${countyRaceRows.length} counties)`;
  }catch(e){
    $('#err').textContent = 'ACS load failed: ' + (e.message || e);
    $('#status').textContent = '';
  }
}

/* ---------- File override for race pies only ---------- */
document.getElementById('file').addEventListener('change', async (e)=>{
  $('#err').textContent=''; $('#status').textContent='Parsing file…';
  const f = e.target.files[0]; if(!f){ $('#status').textContent=''; return; }
  try{
    const wb = await f.arrayBuffer().then(XLSX.read);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:null});
    countyRaceRows = rows.map(r=>{
      const c = String(r.County||'').trim();
      const total=+r.Total||0, aian=+r.AIAN_nonHisp||0, hisp=+r.Hispanic||0, nhb=+r.NH_Black||0, nhw=+r.NH_White||0;
      return {county:c,total,aian,hisp,nhb,nhw,others:Math.max(0,total-(aian+hisp+nhb+nhw))};
    }).filter(r=>r.county).sort((a,b)=>a.county.localeCompare(b.county));
    renderRace();
    $('#status').textContent = `Loaded ${countyRaceRows.length} counties from file (race/ethnicity)`;
  }catch(err){
    $('#err').textContent='File read failed. Use headers: County, Total, AIAN_nonHisp, Hispanic, NH_Black, NH_White.';
    $('#status').textContent='';
  }
});

/* ---------- Init & UI ---------- */
window.addEventListener('DOMContentLoaded', ()=>{
  const savedKey = localStorage.getItem('census_api_key'); if(savedKey) $('#apikey').value = savedKey;

  nmChart = makePie($('#nmChart'));
  brChart = makePie($('#brChart'));

  $('#fetchBtn').addEventListener('click', fetchACS);
  $('#year').addEventListener('change', fetchACS);
  $('#br').addEventListener('change', ()=>{ renderRace(); renderAge(); renderGender(); });

  // PNG buttons for pies
  $('#pngNm').addEventListener('click', ()=>downloadPNG(nmChart,'New_Mexico_pie.png'));
  $('#pngBr').addEventListener('click', ()=>downloadPNG(brChart,$('#brTitle').textContent.replace(/\s+/g,'_')+'.png'));

  fetchACS();
});

function downloadPNG(chart, filename){
  const a = document.createElement('a');
  a.href = chart.toBase64Image('image/png', 1);
  a.download = filename;
  a.click();
}
</script>

<!-- ====== Quick Links Section (unchanged) ====== -->
<section class="quick-links">
  <h2 class="ql-title">Explore More</h2>
  <div class="ql-grid">
    <a class="ql-card" href="https://koushiktripurari.github.io/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/race_website.html" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">👥</span>
      <span class="ql-text">
        <span class="ql-heading">Demographics</span>
        <span class="ql-sub">Population, age, geography</span>
      </span>
    </a>
    <a class="ql-card" href="https://koushiktripurari.github.io/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/Diagnosescounts.html" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🧾</span>
      <span class="ql-text">
        <span class="ql-heading">Diagnoses Counts</span>
        <span class="ql-sub">State & region breakdowns</span>
      </span>
    </a>
    <a class="ql-card" href="https://koushiktripurari.github.io/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/service_example.html" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🩺</span>
      <span class="ql-text">
        <span class="ql-heading">Service Counts</span>
        <span class="ql-sub">BHOP, IOP, Crisis, Residential</span>
      </span>
    </a>
    <a class="ql-card" href="https://koushiktripurari.github.io/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/crisis counts customize site.html" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">📟</span>
      <span class="ql-text">
        <span class="ql-heading">Crisis Data</span>
        <span class="ql-sub">ED visits, mobile crisis, CTC</span>
      </span>
    </a>
    <a class="ql-card" href="https://koushiktripurari.github.io/New-Mexico-Behavioral-Health-Demographics-Dashboard-2023-/all county map.html" target="_blank" rel="noopener">
      <span class="ql-emoji" aria-hidden="true">🗺️</span>
      <span class="ql-text">
        <span class="ql-heading">County Maps — CCBHC, CTC & Crisis</span>
        <span class="ql-sub">Coverage & access by county</span>
      </span>
    </a>
  </div>
</section>

<!-- Minimal styles for quick links -->
<style>
  :root{
    --ql-ink:#111827; --ql-sub:#6b7280; --ql-bg:#ffffff; --ql-line:#e5e7eb;
    --ql-card:#f9fafb; --ql-card-hover:#eef2ff; --ql-border:#e5e7eb;
    --ql-shadow:0 1px 2px rgba(0,0,0,.06), 0 4px 10px rgba(0,0,0,.04);
  }
  .quick-links{margin:24px 0; padding:8px 0}
  .ql-title{margin:0 0 12px; font:600 18px/1.3 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ql-ink)}
  .ql-grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));}
  .ql-card{display:flex; gap:12px; align-items:center; padding:14px 16px; border-radius:14px; background:var(--ql-card); border:1px solid var(--ql-border); text-decoration:none; color:var(--ql-ink); box-shadow:var(--ql-shadow); transition:transform .12s ease, background .12s ease, border-color .12s ease;}
  .ql-card:hover{ transform:translateY(-2px); background:var(--ql-card-hover); border-color:#c7d2fe }
  .ql-emoji{font-size:22px}
  .ql-text{display:flex; flex-direction:column}
  .ql-heading{font-weight:700}
  .ql-sub{font-size:12px; color:var(--ql-sub)}
</style>

</body>
</html>
